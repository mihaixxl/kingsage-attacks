<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <title>KA Attacks Monitor</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; color: #222; padding: 20px; }
    h1 { text-align: center; margin-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; max-width: 1000px; margin: 20px auto; background: white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
    th, td { padding: 8px 12px; border: 1px solid #ccc; text-align: center; }
    th { background: #333; color: white; }
    .countdown { font-weight: bold; padding: 4px 8px; border-radius: 4px; display: inline-block; min-width: 70px; }
    .danger { background: rgba(255, 99, 71, 0.8); color: white; }   /* < 15 min */
    .warning { background: rgba(255, 193, 7, 0.85); color: #222; } /* < 1h */
    .safe { background: rgba(40, 167, 69, 0.7); color: white; }    /* < 3h */
    .long { background: rgba(0, 123, 255, 0.7); color: white; }    /* >= 3h */
    img { height: 20px; vertical-align: middle; }
    .footer { text-align: center; margin-top: 15px; font-size: 14px; color: #666; }
    #filters { text-align: center; margin-bottom: 15px; }
    #filters input { margin: 0 5px; padding: 4px; }
  </style>
</head>
<body>
  <h1>‚öîÔ∏è Monitorizare Atacuri KingsAge</h1>

  <!-- FILTRE -->
  <div id="filters">
    <label>üîé JucƒÉtor: <input type="text" id="filterPlayer" placeholder="ex. Panteraso"></label>
    <label>üìç Coordonate: <input type="text" id="filterCoord" placeholder="ex. 509|495"></label>
    <label>üè∞ Doar snobi: <input type="checkbox" id="filterSnob"></label>
    <button onclick="loadData()">AplicƒÉ filtre</button>
  </div>

  <div id="lastExport" class="footer"></div>
  <table id="attacksTable">
    <thead>
      <tr>
        <th>Tip</th>
        <th>Unitate</th>
        <th>Destina»õie</th>
        <th>Origine</th>
        <th>Sosire</th>
        <th>Timp rƒÉmas</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Sunet pentru snobi -->
  <audio id="snobSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script>
    const GIST_URL = "https://gist.githubusercontent.com/mihaixxl/0fc6426ec97aafcaa3895a31de3b1b5d/raw/ka_attacks.json";
    let lastSnobCount = 0;

    async function loadData() {
      try {
        const res = await fetch(GIST_URL + "?t=" + Date.now());
        const json = await res.json();

        document.getElementById("lastExport").textContent =
          "Ultimul export: " + new Date(json.exportatLa).toLocaleString("ro-RO");

        const tbody = document.querySelector("#attacksTable tbody");
        tbody.innerHTML = "";

        // üîπ Filtre
        const fPlayer = document.getElementById("filterPlayer").value.toLowerCase();
        const fCoord = document.getElementById("filterCoord").value;
        const fSnob = document.getElementById("filterSnob").checked;

        let snobCount = 0;

        json.data.forEach(atac => {
          if (fPlayer && !atac.origine.toLowerCase().includes(fPlayer) && !atac.destin.toLowerCase().includes(fPlayer)) return;
          if (fCoord && !atac.destin.includes(fCoord)) return;
          if (fSnob && !atac.unitImg.includes("unit_snob")) return;

          if (atac.unitImg.includes("unit_snob")) snobCount++;

          const tr = document.createElement("tr");
          const ts = new Date(atac.sosire).getTime();

          tr.innerHTML = `
            <td>${atac.tip}</td>
            <td><img src="${atac.unitImg}"></td>
            <td>${atac.destin}</td>
            <td>${atac.origine}</td>
            <td>${atac.sosire}</td>
            <td><span class="countdown" data-timestamp="${ts}"></span></td>
          `;
          tbody.appendChild(tr);
        });

        // Sunet dacƒÉ a apƒÉrut un snob nou
        if (snobCount > lastSnobCount) {
          document.getElementById("snobSound").play();
        }
        lastSnobCount = snobCount;

        updateCountdowns();
      } catch (e) {
        console.error("Eroare la √ÆncƒÉrcare JSON", e);
      }
    }

    function formatTime(sec) {
      let h = Math.floor(sec / 3600);
      let m = Math.floor((sec % 3600) / 60);
      let s = sec % 60;
      return `${h}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    }

    function updateCountdowns() {
      const now = Date.now();
      document.querySelectorAll(".countdown").forEach(span => {
        const ts = parseInt(span.getAttribute("data-timestamp"), 10);
        let sec = Math.floor((ts - now) / 1000);
        if (sec < 0) sec = 0;

        span.textContent = formatTime(sec);

        span.className = "countdown";
        if (sec < 15 * 60) span.classList.add("danger");
        else if (sec < 60 * 60) span.classList.add("warning");
        else if (sec < 3 * 3600) span.classList.add("safe");
        else span.classList.add("long");
      });
    }

    loadData();
    setInterval(loadData, 60000);   // la 1 minut
    setInterval(updateCountdowns, 1000); // update la secundƒÉ
  </script>
</body>
</html>